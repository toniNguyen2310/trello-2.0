import React, { useState, useRef, useEffect, use } from 'react'
import Column from '../Column/Column'
import { initDataBoard } from '../../utils/initColumnData'
import AddNewColumn from '../AddNewColumn/AddNewColumn'
import { resetDataDrag, sortOrder } from '../../utils/constants'
import { swapColumnsInRef } from '../../utils/swapColumnsInRef '


const BoardContent = () => {
  const [columns, setColumns] = useState([])
  const listColumnsRef = useRef({})

  //ghost ref
  const [distanceXFirst, distanceYFirst, cloneCarOrColumnRef] = [
    useRef(null),
    useRef(null),
    useRef(null),
  ];
  //value dragging
  let valueDragStartRef = useRef({
    sourceCardId: null,
    sourceColumnId: null,
    isDragging: false
  })
  let valueDragEndRef = useRef({
    targetCardId: null,
    targetColumnId: null,
    isInsertEnd: false
  })

  // --- MOUNT: load data ---
  useEffect(() => {
    //Render d·ªØ li·ªáu API or LS
    listColumnsRef.current = initDataBoard
    setColumns(sortOrder(initDataBoard.columns, initDataBoard.columnOrder, "id"))
  }, [])


  // Add New Column
  // const handleAddColumn = (title) => {
  //   const newColumn = { title, cards: [] }
  //   setColumns([...columns, newColumn])
  // }


  // --- MOUSE UP: swap column n·∫øu ƒëang k√©o column ---
  useEffect(() => {
    const handleMouseUpColumn = (e) => {
      e.preventDefault();
      const { sourceCardId, sourceColumnId, isDragging } = valueDragStartRef.current;
      const { targetColumnId } = valueDragEndRef.current;

      // Ch·ªâ x·ª≠ l√Ω drag column, kh√¥ng ph·∫£i card, v√† ph·∫£i ƒëang drag
      if (!isDragging || sourceCardId || !sourceColumnId) return;

      //Delete Ghost
      if (cloneCarOrColumnRef.current) {
        cloneCarOrColumnRef.current.remove()
        cloneCarOrColumnRef.current = null
      }

      // N·∫øu ch·ªâ click m√† kh√¥ng k√©o ƒëi ƒë√¢u
      if (!targetColumnId) {
        resetDataDrag(valueDragStartRef, valueDragEndRef);
        return
      }

      // Swap trong ref v√† c·∫≠p nh·∫≠t state
      swapColumnsInRef(listColumnsRef, sourceColumnId, targetColumnId)
      setColumns([...listColumnsRef.current.columns])
      resetDataDrag(valueDragStartRef, valueDragEndRef);

    }

    document.addEventListener("mouseup", handleMouseUpColumn);
    return () => document.removeEventListener("mouseup", handleMouseUpColumn);
  }, [])

  // --- MOUSE MOVE: x·ª≠ l√Ω ghost + placeholder (column & card) ---
  useEffect(() => {
    const handleMouseMoveColumn = (e) => {
      e.preventDefault();
      const { sourceCardId, sourceColumnId, isDragging } = valueDragStartRef.current;
      if (!isDragging) return;
      //L·ªñI B√îI ƒêEN
      document.body.classList.add("dragging");

      // Di chuy·ªÉn Ghost theo chu·ªôt
      if (cloneCarOrColumnRef.current) {
        cloneCarOrColumnRef.current.style.left = e.pageX - distanceXFirst.current + 'px'
        cloneCarOrColumnRef.current.style.top = e.pageY - distanceYFirst.current + 'px'
        cloneCarOrColumnRef.current.style.opacity = `0.8`
      }

      //Handle Placeholder Dragging
      const colEl = e.target.closest("[data-column-id]");
      const hoverColId = colEl?.dataset.columnId


      if (!sourceCardId) {
        //DRAG COLUMN: Just Hover Column
        if (hoverColId && hoverColId !== valueDragEndRef.current.targetColumnId) {
          console.log('hoverColId>> ', hoverColId)
          valueDragEndRef.current.targetColumnId = hoverColId
          // reset placeholder
          document.querySelectorAll(".isPlaceholderColumn").forEach((el) => {
            el.classList.remove("isPlaceholderColumn");
          });
          colEl.classList.add("isPlaceholderColumn");
        }
        return
      }

      // LOGIC CU
      // if (hoverColId && sourceColumnId) {
      //   // Ki·ªÉm tra n·∫øu v·ªã tr√≠ m·ªõi kh√°c v·ªã tr√≠ c≈© -> so s√°nh 2 v·ªã tr√≠ g·∫ßn nh·∫•t v√† hi·ªán t·∫°i
      //   const prev = valueDragEndRef.current;
      //   const isDifferent = !prev || prev.targetColumnId !== hoverColId;
      //   if (isDifferent) {
      //     // ‚úÖ C·∫≠p nh·∫≠t ref
      //     valueDragEndRef.current = {
      //       ...valueDragEndRef.current,
      //       targetColumnId: hoverColId
      //     }
      //     // / ‚úÖ Xo√° t·∫•t c·∫£ .isPlaceholderColumn
      //     document.querySelectorAll(".isPlaceholderColumn").forEach((el) => {
      //       el.classList.remove("isPlaceholderColumn");
      //     });
      //     // ‚úÖ Th√™m class v√†o th·∫ª ƒë√≠ch
      //     const newColumnTargetEl = document.querySelector(
      //       `[data-column-id="${hoverColId}"]`
      //     );

      //     if (newColumnTargetEl) {
      //       newColumnTargetEl.classList.add("isPlaceholderColumn");
      //     }
      //   }



      // } else {
      //   console.log('HOVER C·ªòT V√ÄO KHO·∫¢NG TR·ªêNG', valueDragEndRef.current?.targetColumnId)
      //   //n·∫øu hover v√†o ƒë√¢y th√¨ l·∫•y d·ªØ li·ªáu t·ª´ tr∆∞·ªõc trong ref
      //   //Ph·∫ßn n√†y kh√¥ng c·∫ßn l√†m g√¨ c·∫£, tuy nhi√™n n·∫øu l·ªói s·∫Ω r∆°i v√†o ƒë√¢y

      // }
    }

    //COLUMN
    document.addEventListener("mousemove", handleMouseMoveColumn);
    return () => document.removeEventListener("mousemove", handleMouseMoveColumn);

  }, [])

  //Move Move Card
  useEffect(() => {
    const handleMouseMoveCard = (e) => {
      e.preventDefault();
      const { sourceCardId, sourceColumnId, isDragging } = valueDragStartRef.current;
      if (!isDragging) return;
      //L·ªñI B√îI ƒêEN
      document.body.classList.add("dragging");
      // Di chuy·ªÉn Ghost theo chu·ªôt
      if (cloneCarOrColumnRef.current) {
        cloneCarOrColumnRef.current.style.left = e.pageX - distanceXFirst.current + 'px'
        cloneCarOrColumnRef.current.style.top = e.pageY - distanceYFirst.current + 'px'
        cloneCarOrColumnRef.current.style.opacity = `0.8`
      }
      //Handle Placeholder Dragging
      const colEl = e.target.closest("[data-column-id]");
      const cardEl = e.target.closest("[data-card-id]");
      const hoverColId = colEl?.dataset.columnId
      const hoverCardId = cardEl?.dataset.cardId;

      // Case 1: Hover v√†o m·ªôt th·∫ª
      if (hoverColId && hoverCardId) {
        if (valueDragEndRef.current.targetColumnId !== hoverColId
          || valueDragEndRef.current.targetCardId !== hoverCardId) {
          // Ki·ªÉm tra n·∫øu v·ªã tr√≠ m·ªõi kh√°c v·ªã tr√≠ c≈© -> so s√°nh 2 v·ªã tr√≠ g·∫ßn nh·∫•t v√† hi·ªán t·∫°i
          valueDragEndRef.current = {
            targetColumnId: hoverColId,
            targetCardId: hoverCardId,
            isInsertEnd: false
          }
          document.querySelectorAll('.isCardDragging')
            .forEach(el => el.classList.remove('isCardDragging'))
          cardEl.classList.add('isCardDragging')
        }
        return
      }

      //Case 2: Hover v√†o c·ªôt r·ªóng
      if (colEl && colEl.querySelectorAll('[data-card-id]').length === 0) {
        if (valueDragEndRef.current.targetColumnId !== hoverColId
          || valueDragEndRef.current.targetColumnId !== null) {
          valueDragEndRef.current = {
            targetColumnId: hoverColId,
            targetCardId: null,
            isInsertEnd: true
          };
          document.querySelectorAll('.isCardDragging')
            .forEach(el => el.classList.remove('isCardDragging'))
        }
        return
      }

      //Case 3 : Hover kho·∫£ng tr·ªëng kh√¥ng thu·ªôc (th·∫ª/c·ªôt) ho·∫∑c title/footer c·ªôt
      const isOnFooterCol = e.target.classList.contains('add-card')
      const isOnTitleCol = e.target.classList.contains('column-title-display')
      if (colEl && (isOnFooterCol || isOnTitleCol)) {
        const direction = isOnFooterCol ? 'last' : 'first'
        const column = listColumnsRef.current.columns.find(c => c.id === hoverColId)
        const cards = column?.cardOrder || []
        // N·∫øu c·ªôt kh√¥ng c√≥ th·∫ª -> return
        if (cards.length == 0) return

        const tgtCardId = direction === 'last' ? cards[cards.length - 1] : cards[0]

        const isFirstCardSource = colEl.querySelectorAll('[data-card-id]')?.[0]?.dataset.cardId === sourceCardId

        //C√πng c·ªôt && (c·ªôt ch·ªâ c√≥ 1 th·∫ª  || sourceCardId l√† th·∫ª ƒë·∫ßu ti√™n trong c·ªôt) -> return
        if (sourceColumnId === hoverColId && (cards.length === 1 || isFirstCardSource)) return
        const isSameAsCurrent = valueDragEndRef.current.targetColumnId === hoverColId
          && valueDragEndRef.current.targetCardId === tgtCardId
          && valueDragEndRef.current.isInsertEnd === (direction === 'last')
        if (!isSameAsCurrent) {
          document.querySelectorAll('.isCardDragging').forEach(el => el.classList.remove('isCardDragging'))
          valueDragEndRef.current = {
            targetColumnId: hoverColId,
            targetCardId: tgtCardId,
            isInsertEnd: direction === 'last'
          }
          const tgtCardIdEl = colEl.querySelector(`[data-card-id="${tgtCardId}"]`)
          if (tgtCardIdEl) {
            tgtCardIdEl.classList.add('isCardDragging')
          }
        }
        return
      }


      // LOGIC C≈®

      // if (!valueDragStartRef.current.isDragging || !valueDragStartRef.current.sourceCardId) return
      // //L·ªñI B√îI ƒêEN
      // document.body.classList.add("dragging");

      // //GHOST CARD
      // const newX = e.pageX - distanceXFirst.current
      // const newY = e.pageY - distanceYFirst.current
      // if (cloneCarOrColumnRef.current) {
      //   cloneCarOrColumnRef.current.style.left = `${newX}px`
      //   cloneCarOrColumnRef.current.style.top = `${newY}px`
      //   cloneCarOrColumnRef.current.style.opacity = `0.8`
      // }

      // //Handle Placeholder Dragging
      // const colEl = e.target.closest("[data-column-id]");
      // const foundColumnId = colEl?.dataset.columnId
      // const cardEl = e.target.closest("[data-card-id]");
      // const foundCardId = cardEl?.dataset.cardId;


      // // üß† Tr∆∞·ªùng h·ª£p 1: Hover v√†o 1 th·∫ª (c√≥ columnId v√† cardId)
      // if (foundColumnId !== undefined && foundCardId !== undefined) {
      //   // Ki·ªÉm tra n·∫øu v·ªã tr√≠ m·ªõi kh√°c v·ªã tr√≠ c≈© -> so s√°nh 2 v·ªã tr√≠ g·∫ßn nh·∫•t v√† hi·ªán t·∫°i
      //   const prev = valueDragEndRef.current;
      //   const isDifferent =
      //     !prev ||
      //     prev.targetColumnId !== foundColumnId ||
      //     prev.targetCardId !== foundCardId;

      //   if (isDifferent) {
      //     // ‚úÖ C·∫≠p nh·∫≠t ref
      //     valueDragEndRef.current = {
      //       targetColumnId: foundColumnId,
      //       targetCardId: foundCardId
      //     };
      //     // ‚úÖ Xo√° t·∫•t c·∫£ .isCardDragging
      //     document.querySelectorAll(".isCardDragging").forEach((el) => {
      //       el.classList.remove("isCardDragging");
      //     });
      //     // ‚úÖ Th√™m class v√†o th·∫ª ƒë√≠ch
      //     const newCardTargetEl = document.querySelector(
      //       `[data-card-id="${foundCardId}"][ data-card-columnid="${foundColumnId}"]`
      //     );

      //     if (newCardTargetEl) {
      //       newCardTargetEl.classList.add("isCardDragging");
      //     }

      //   }
      // }
      // // üß† Tr∆∞·ªùng h·ª£p 2: Hover v√†o c·ªôt r·ªóng
      // else if (foundColumnId !== undefined && colEl?.querySelectorAll("[data-card-id]").length === 0) {
      //   const prev = valueDragEndRef.current;
      //   const isDifferent =
      //     !prev ||
      //     prev.targetColumnId !== foundColumnId ||
      //     prev.targetCardId !== null;

      //   if (isDifferent) {
      //     valueDragEndRef.current = {
      //       targetColumnId: foundColumnId,
      //       targetCardId: null,
      //     };

      //     // ‚úÖ Xo√° class placeholder n·∫øu ƒëang c√≥
      //     document.querySelectorAll(".isCardDragging").forEach((el) => {
      //       el.classList.remove("isCardDragging");
      //     });

      //   }

      // }
      // // üß† Tr∆∞·ªùng h·ª£p 3: Hover kho·∫£ng tr·ªëng kh√¥ng thu·ªôc th·∫ª/c·ªôt => b·ªè qua
      // else {

      //   function getCardInColumnByPosition(columns, columnId, position = 'last') {
      //     const column = columns.find(col => col.id === columnId);
      //     if (!column || column.cardOrder.length === 0) return null;

      //     const cardId = position === 'first'
      //       ? column.cardOrder[0]
      //       : column.cardOrder[column.cardOrder.length - 1];

      //     const card = column.cards.find(card => card.id === cardId);
      //     return card || null;
      //   }

      //   // Tr∆∞·ªùng h·ª£p 1: Hover in titile  or footer title
      //   if (e.target.classList.contains('add-card')) {
      //     let lastCard = getCardInColumnByPosition(listColumnsRef.current.columns, foundColumnId, 'last')

      //     const cardEls = colEl?.querySelectorAll("[data-card-id]");
      //     const isFirstCardSource = cardEls?.[0]?.getAttribute("data-card-id") === valueDragStartRef.current.sourceCardId;

      //     if (valueDragStartRef.current.sourceColumnId === foundColumnId && cardEls.length === 1 || isFirstCardSource) {
      //       //C√πng c·ªôt, c·ªôt 1 th·∫ª or th·∫ª ƒë√≥ l√† th·∫ª ƒë·∫ßu ti√™n-> return
      //       return
      //     }
      //     else {
      //       // ‚úÖ Xo√° class placeholder n·∫øu ƒëang c√≥
      //       document.querySelectorAll(".isCardDragging").forEach((el) => {
      //         el.classList.remove("isCardDragging");
      //       });
      //       valueDragEndRef.current = {
      //         targetColumnId: foundColumnId,
      //         targetCardId: lastCard.id,
      //         isInsertEnd: true
      //       };
      //     }
      //   } else if (e.target.classList.contains('column-title-display')) {
      //     let firstCard = getCardInColumnByPosition(listColumnsRef.current.columns, foundColumnId, 'first')

      //     const cardEls = colEl?.querySelectorAll("[data-card-id]");
      //     const isFirstCardSource = cardEls?.[0]?.getAttribute("data-card-id") === valueDragStartRef.current.sourceCardId;

      //     if (valueDragStartRef.current.sourceColumnId === foundColumnId && cardEls.length === 1 || isFirstCardSource) {
      //       //C√πng c·ªôt, c·ªôt 1 th·∫ª or th·∫ª ƒë√≥ l√† th·∫ª ƒë·∫ßu ti√™n-> return
      //       return
      //     }
      //     else {
      //       // ‚úÖ Xo√° class placeholder n·∫øu ƒëang c√≥
      //       document.querySelectorAll(".isCardDragging").forEach((el) => {
      //         el.classList.remove("isCardDragging");
      //       });

      //       valueDragEndRef.current = {
      //         targetColumnId: foundColumnId,
      //         targetCardId: firstCard.id,
      //         isInsertEnd: false
      //       };
      //     }
      //   }
      // }
    }
    //CARD
    document.addEventListener("mousemove", handleMouseMoveCard);
    return () => document.removeEventListener("mousemove", handleMouseMoveCard)

  }, [])





  return (
    <div className="board-content">
      {/* Render List Column */}
      {columns.map((column, index) => (
        <Column
          key={column.id}
          columnProps={column}
          valueDragStartRef={valueDragStartRef}
          valueDragEndRef={valueDragEndRef}
          distanceXFirst={distanceXFirst}
          distanceYFirst={distanceYFirst}
          cloneCarOrColumnRef={cloneCarOrColumnRef}
          listColumnsRef={listColumnsRef}
        />
      ))}

      {/* button to create new column */}
      {/* <AddNewColumn onAddColumn={handleAddColumn} /> */}
    </div>

  )
}

export default BoardContent
